#!/bin/bash
set -e
set -u
set -o pipefail

################################################################################
# Run a test harness.
# Invoke as "ci/test".
################################################################################
. ci/bootstrap

main() {
  if [[ ${UP2DATE} == true ]]; then
    info "Image is up-to-date on docker hub; nothing left to do."
  else
    run_precommit
    run_bats
  fi
}

run_precommit() {
  pre-commit run --all-files --verbose
}

run_bats() {
  echo
  echo Invoke BATS tests.
  bats ci/test_*.bats
}

################################################################################
# Program execution starts here.
################################################################################

. ci/helpers.sh
. ci/vars

main
